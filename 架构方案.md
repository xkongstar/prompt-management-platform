## 技术架构分析 v2.0 (前后端分离)

### 1. 整体架构设计

**前端架构 (Web Client)**

- **框架**: React 18 + TypeScript + Vite
- **路由**: React Router v6
- **状态管理**: Zustand + TanStack Query (React Query)
- **UI组件库**: Ant Design 5.x + Styled Components
- **表单处理**: React Hook Form + Yup验证
- **富文本编辑**: Monaco Editor + CodeMirror
- **HTTP客户端**: Axios + 请求拦截器


**后端架构 (API Server)**

- **框架**: Node.js + Express.js + TypeScript
- **ORM**: Prisma + PostgreSQL
- **认证**: JWT + Passport.js
- **API文档**: Swagger/OpenAPI 3.0
- **文件上传**: Multer + 云存储(阿里云OSS/AWS S3)
- **缓存**: Redis
- **日志**: Winston + Morgan


**数据库架构**

- **主数据库**: PostgreSQL 14+
- **缓存层**: Redis 6+
- **搜索引擎**: Elasticsearch (可选) 或 PostgreSQL全文检索


### 2. 项目结构设计

```plaintext
prompt-management-platform/
├── frontend/                 # 前端项目
│   ├── src/
│   │   ├── components/      # 通用组件
│   │   ├── pages/          # 页面组件
│   │   ├── hooks/          # 自定义Hooks
│   │   ├── services/       # API服务层
│   │   ├── stores/         # 状态管理
│   │   ├── types/          # TypeScript类型
│   │   └── utils/          # 工具函数
│   ├── public/
│   └── package.json
├── backend/                 # 后端项目
│   ├── src/
│   │   ├── controllers/    # 控制器
│   │   ├── services/       # 业务逻辑层
│   │   ├── models/         # 数据模型
│   │   ├── middleware/     # 中间件
│   │   ├── routes/         # 路由定义
│   │   ├── utils/          # 工具函数
│   │   └── types/          # TypeScript类型
│   ├── prisma/             # 数据库Schema
│   └── package.json
└── docker-compose.yml      # 本地开发环境
```

### 3. 后端API架构设计

#### 3.1 RESTful API设计规范

```typescript
// API基础结构
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  message?: string;
  errors?: ValidationError[];
  pagination?: PaginationMeta;
}

// 统一错误处理
interface ApiError {
  code: string;
  message: string;
  details?: any;
}
```

#### 3.2 核心API接口

**认证模块**

```typescript
POST   /api/v1/auth/register        # 用户注册
POST   /api/v1/auth/login           # 用户登录
POST   /api/v1/auth/refresh         # 刷新Token
POST   /api/v1/auth/logout          # 用户登出
GET    /api/v1/auth/profile         # 获取用户信息
PUT    /api/v1/auth/profile         # 更新用户信息
```

**项目管理模块**

```typescript
GET    /api/v1/projects                    # 获取项目列表
POST   /api/v1/projects                    # 创建项目
GET    /api/v1/projects/:id                # 获取项目详情
PUT    /api/v1/projects/:id                # 更新项目
DELETE /api/v1/projects/:id                # 删除项目
GET    /api/v1/projects/:id/statistics     # 项目统计信息
```

**提示词管理模块**

```typescript
GET    /api/v1/prompts                     # 获取提示词列表
POST   /api/v1/prompts                     # 创建提示词
GET    /api/v1/prompts/:id                 # 获取提示词详情
PUT    /api/v1/prompts/:id                 # 更新提示词
DELETE /api/v1/prompts/:id                 # 删除提示词
POST   /api/v1/prompts/:id/duplicate       # 复制提示词
POST   /api/v1/prompts/:id/favorite        # 收藏/取消收藏
```

**版本控制模块**

```typescript
GET    /api/v1/prompts/:id/versions        # 获取版本历史
GET    /api/v1/prompts/:id/versions/:version # 获取特定版本
POST   /api/v1/prompts/:id/versions        # 创建新版本
POST   /api/v1/prompts/:id/revert/:version # 回退到指定版本
GET    /api/v1/prompts/:id/diff/:v1/:v2    # 版本差异对比
```

**协作管理模块**

```typescript
GET    /api/v1/projects/:id/members        # 获取项目成员
POST   /api/v1/projects/:id/invitations    # 发送邀请
PUT    /api/v1/projects/:id/members/:userId # 更新成员权限
DELETE /api/v1/projects/:id/members/:userId # 移除成员
GET    /api/v1/invitations                 # 获取邀请列表
POST   /api/v1/invitations/:id/accept      # 接受邀请
POST   /api/v1/invitations/:id/decline     # 拒绝邀请
```

**搜索模块**

```typescript
GET    /api/v1/search/prompts              # 搜索提示词
GET    /api/v1/search/suggestions          # 搜索建议
POST   /api/v1/search/advanced             # 高级搜索
```

**标签管理模块**

```typescript
GET    /api/v1/tags                        # 获取标签列表
POST   /api/v1/tags                        # 创建标签
PUT    /api/v1/tags/:id                    # 更新标签
DELETE /api/v1/tags/:id                    # 删除标签
GET    /api/v1/tags/popular                # 热门标签
```

**导入导出模块**

```typescript
POST   /api/v1/import/csv                  # CSV批量导入
POST   /api/v1/import/json                 # JSON批量导入
GET    /api/v1/export/csv                  # CSV导出
GET    /api/v1/export/json                 # JSON导出
POST   /api/v1/snapshots                   # 创建快照
GET    /api/v1/snapshots                   # 获取快照列表
POST   /api/v1/snapshots/:id/restore       # 恢复快照
```

### 4. 前端架构设计

#### 4.1 状态管理架构

```typescript
// 全局状态管理
interface AppState {
  auth: AuthState;
  projects: ProjectState;
  prompts: PromptState;
  ui: UIState;
}

// 使用Zustand进行状态管理
const useAuthStore = create<AuthState>((set) => ({
  user: null,
  token: null,
  login: async (credentials) => { /* ... */ },
  logout: () => { /* ... */ }
}));

// 使用TanStack Query进行服务端状态管理
const usePrompts = (projectId: string) => {
  return useQuery({
    queryKey: ['prompts', projectId],
    queryFn: () => promptService.getPrompts(projectId)
  });
};
```

#### 4.2 路由设计

```typescript
// 路由配置
const router = createBrowserRouter([
  {
    path: "/",
    element: <AppLayout />,
    children: [
      { path: "/", element: <Dashboard /> },
      { path: "/projects", element: <ProjectList /> },
      { path: "/projects/:id", element: <ProjectDetail /> },
      { path: "/projects/:id/prompts", element: <PromptList /> },
      { path: "/prompts/:id", element: <PromptDetail /> },
      { path: "/prompts/:id/edit", element: <PromptEditor /> },
      { path: "/prompts/:id/versions", element: <VersionHistory /> },
      { path: "/search", element: <SearchPage /> },
      { path: "/favorites", element: <FavoritesList /> },
      { path: "/settings", element: <Settings /> }
    ]
  },
  {
    path: "/auth",
    element: <AuthLayout />,
    children: [
      { path: "/auth/login", element: <Login /> },
      { path: "/auth/register", element: <Register /> }
    ]
  }
]);
```

#### 4.3 服务层设计

```typescript
// API服务层
class ApiClient {
  private axios: AxiosInstance;
  
  constructor() {
    this.axios = axios.create({
      baseURL: process.env.REACT_APP_API_URL,
      timeout: 10000
    });
    
    // 请求拦截器 - 添加认证头
    this.axios.interceptors.request.use((config) => {
      const token = localStorage.getItem('token');
      if (token) {
        config.headers.Authorization = `Bearer ${token}`;
      }
      return config;
    });
    
    // 响应拦截器 - 统一错误处理
    this.axios.interceptors.response.use(
      (response) => response.data,
      (error) => {
        if (error.response?.status === 401) {
          // 处理认证失效
          authStore.logout();
        }
        return Promise.reject(error);
      }
    );
  }
}

// 具体服务实现
class PromptService extends ApiClient {
  async getPrompts(projectId: string, params?: QueryParams) {
    return this.axios.get(`/prompts`, { params: { projectId, ...params } });
  }
  
  async createPrompt(data: CreatePromptDto) {
    return this.axios.post('/prompts', data);
  }
  
  async updatePrompt(id: string, data: UpdatePromptDto) {
    return this.axios.put(`/prompts/${id}`, data);
  }
}
```

### 5. 数据库设计

#### 5.1 核心表结构

```sql
-- 用户表
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(100) NOT NULL,
  avatar_url TEXT,
  role user_role DEFAULT 'user',
  email_verified BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 项目表
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(200) NOT NULL,
  description TEXT,
  owner_id UUID REFERENCES users(id) ON DELETE CASCADE,
  visibility project_visibility DEFAULT 'private',
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 提示词表
CREATE TABLE prompts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(500) NOT NULL,
  content TEXT NOT NULL,
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,
  status prompt_status DEFAULT 'draft',
  version INTEGER DEFAULT 1,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 版本历史表
CREATE TABLE prompt_versions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  prompt_id UUID REFERENCES prompts(id) ON DELETE CASCADE,
  version INTEGER NOT NULL,
  title VARCHAR(500) NOT NULL,
  content TEXT NOT NULL,
  change_log TEXT,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 标签表
CREATE TABLE tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  color VARCHAR(7) DEFAULT '#1890ff',
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(name, project_id)
);

-- 提示词标签关联表
CREATE TABLE prompt_tags (
  prompt_id UUID REFERENCES prompts(id) ON DELETE CASCADE,
  tag_id UUID REFERENCES tags(id) ON DELETE CASCADE,
  PRIMARY KEY (prompt_id, tag_id)
);

-- 项目协作者表
CREATE TABLE project_collaborators (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role collaborator_role DEFAULT 'viewer',
  permissions JSONB DEFAULT '{}',
  invited_by UUID REFERENCES users(id) ON DELETE SET NULL,
  joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(project_id, user_id)
);
```

### 6. 部署架构

#### 6.1 容器化部署

```yaml
# docker-compose.yml
version: '3.8'
services:
  frontend:
    build: ./frontend
    ports:
      - "3000:80"
    environment:
      - REACT_APP_API_URL=http://localhost:8000/api/v1
    depends_on:
      - backend

  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/promptdb
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=your-secret-key
    depends_on:
      - postgres
      - redis

  postgres:
    image: postgres:14
    environment:
      - POSTGRES_DB=promptdb
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:6-alpine
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

#### 6.2 生产环境部署方案

**方案一：云服务器部署**

- 前端：Nginx + 静态文件托管
- 后端：PM2 + Node.js
- 数据库：云数据库RDS
- 缓存：云Redis
- 文件存储：对象存储OSS


**方案二：容器化部署**

- 容器编排：Docker Swarm 或 Kubernetes
- 负载均衡：Nginx 或 云负载均衡
- 监控：Prometheus + Grafana
- 日志：ELK Stack


### 7. 开发工作流

#### 7.1 前端开发流程

```shellscript
# 开发环境启动
cd frontend
npm install
npm run dev

# 构建生产版本
npm run build
npm run preview
```

#### 7.2 后端开发流程

```shellscript
# 开发环境启动
cd backend
npm install
npm run dev

# 数据库迁移
npx prisma migrate dev
npx prisma generate

# API文档生成
npm run docs:generate
```

### 8. 技术选型优势

**前后端分离优势**：

- 独立开发部署，团队协作效率高
- 技术栈灵活，可独立升级
- 水平扩展能力强
- 支持多端复用（Web、移动端、桌面端）


**React生态优势**：

- 组件化开发，代码复用性高
- 丰富的第三方库支持
- 强大的开发者工具
- 活跃的社区支持


**Node.js后端优势**：

- JavaScript全栈开发
- 高并发处理能力
- NPM生态丰富
- 快速原型开发
