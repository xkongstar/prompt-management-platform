# 提示词管理平台 - 测试策略文档

## 1. 测试概述

### 1.1 测试目标
- 确保核心功能正常运行
- 保证数据的准确性和一致性
- 验证用户界面的友好性和响应性
- 确保API接口的稳定性和安全性

### 1.2 测试范围
- 前端功能测试
- 后端API测试
- 数据库完整性测试
- 集成测试
- 用户验收测试

### 1.3 测试原则
- 自动化优先，手工测试补充
- 持续集成，快速反馈
- 测试覆盖率目标：核心功能 80%，整体 60%

## 2. 测试架构

### 2.1 前端测试技术栈
```javascript
{
  "单元测试": "Jest + React Testing Library",
  "组件测试": "Storybook",
  "E2E测试": "Playwright 或 Cypress",
  "代码覆盖率": "Istanbul"
}
```

### 2.2 后端测试技术栈
```javascript
{
  "单元测试": "Jest",
  "API测试": "Supertest",
  "数据库测试": "Prisma测试工具",
  "Mock工具": "MSW (Mock Service Worker)"
}
```

## 3. 测试策略详细设计

### 3.1 单元测试

#### 前端单元测试

**测试范围**
- React组件的渲染和交互
- 自定义Hooks的逻辑
- 工具函数和业务逻辑
- 状态管理（Zustand stores）

**示例：组件测试**
```typescript
// PromptCard.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { PromptCard } from './PromptCard';

describe('PromptCard', () => {
  const mockPrompt = {
    id: '1',
    title: 'Test Prompt',
    content: 'Test content',
    tags: ['tag1', 'tag2'],
    isFavorite: false
  };

  test('renders prompt information correctly', () => {
    render(<PromptCard prompt={mockPrompt} />);
    expect(screen.getByText('Test Prompt')).toBeInTheDocument();
    expect(screen.getByText('tag1')).toBeInTheDocument();
  });

  test('handles favorite toggle', async () => {
    const onFavorite = jest.fn();
    render(<PromptCard prompt={mockPrompt} onFavorite={onFavorite} />);
    
    const favoriteButton = screen.getByRole('button', { name: /favorite/i });
    fireEvent.click(favoriteButton);
    
    expect(onFavorite).toHaveBeenCalledWith('1');
  });
});
```

**示例：Hook测试**
```typescript
// usePrompts.test.ts
import { renderHook, waitFor } from '@testing-library/react';
import { usePrompts } from './usePrompts';

test('fetches prompts successfully', async () => {
  const { result } = renderHook(() => usePrompts('project-1'));
  
  await waitFor(() => {
    expect(result.current.isLoading).toBe(false);
  });
  
  expect(result.current.data).toHaveLength(3);
  expect(result.current.error).toBeNull();
});
```

#### 后端单元测试

**测试范围**
- Service层业务逻辑
- 中间件功能
- 工具函数
- 数据验证

**示例：Service测试**
```typescript
// promptService.test.ts
import { PromptService } from './promptService';
import { prismaMock } from '../test/prisma-mock';

describe('PromptService', () => {
  let service: PromptService;

  beforeEach(() => {
    service = new PromptService();
  });

  test('creates prompt with version', async () => {
    const promptData = {
      title: 'New Prompt',
      content: 'Content',
      projectId: 'project-1',
      authorId: 'user-1'
    };

    prismaMock.prompt.create.mockResolvedValue({
      id: 'prompt-1',
      ...promptData,
      version: 1,
      createdAt: new Date(),
      updatedAt: new Date()
    });

    const result = await service.createPrompt(promptData);
    
    expect(result.version).toBe(1);
    expect(prismaMock.promptVersion.create).toHaveBeenCalled();
  });

  test('updates prompt and creates new version', async () => {
    const updateData = { content: 'Updated content' };
    
    prismaMock.prompt.findUnique.mockResolvedValue({
      id: 'prompt-1',
      version: 1,
      content: 'Old content'
    });

    const result = await service.updatePrompt('prompt-1', updateData);
    
    expect(result.version).toBe(2);
    expect(prismaMock.promptVersion.create).toHaveBeenCalled();
  });
});
```

### 3.2 集成测试

#### API集成测试

**测试范围**
- 完整的API请求流程
- 认证和授权
- 数据验证和错误处理
- 数据库事务

**示例：API测试**
```typescript
// api.test.ts
import request from 'supertest';
import { app } from '../app';
import { setupTestDatabase, teardownTestDatabase } from '../test/db-setup';

describe('Prompt API', () => {
  let authToken: string;

  beforeAll(async () => {
    await setupTestDatabase();
    // 登录获取token
    const response = await request(app)
      .post('/api/v1/auth/login')
      .send({ email: 'test@example.com', password: 'password' });
    authToken = response.body.data.token;
  });

  afterAll(async () => {
    await teardownTestDatabase();
  });

  describe('POST /api/v1/prompts', () => {
    test('creates prompt successfully', async () => {
      const response = await request(app)
        .post('/api/v1/prompts')
        .set('Authorization', `Bearer ${authToken}`)
        .send({
          title: 'Test Prompt',
          content: 'Test content',
          projectId: 'project-1',
          tags: ['test']
        });

      expect(response.status).toBe(201);
      expect(response.body.success).toBe(true);
      expect(response.body.data).toHaveProperty('id');
      expect(response.body.data.version).toBe(1);
    });

    test('validates required fields', async () => {
      const response = await request(app)
        .post('/api/v1/prompts')
        .set('Authorization', `Bearer ${authToken}`)
        .send({ title: 'Missing content' });

      expect(response.status).toBe(400);
      expect(response.body.errors).toContainEqual(
        expect.objectContaining({ field: 'content' })
      );
    });

    test('requires authentication', async () => {
      const response = await request(app)
        .post('/api/v1/prompts')
        .send({ title: 'Test', content: 'Test' });

      expect(response.status).toBe(401);
    });
  });

  describe('GET /api/v1/prompts/:id/versions', () => {
    test('returns version history', async () => {
      const response = await request(app)
        .get('/api/v1/prompts/prompt-1/versions')
        .set('Authorization', `Bearer ${authToken}`);

      expect(response.status).toBe(200);
      expect(response.body.data).toBeInstanceOf(Array);
      expect(response.body.data[0]).toHaveProperty('version');
      expect(response.body.data[0]).toHaveProperty('changeLog');
    });
  });
});
```

### 3.3 端到端测试（E2E）

**测试范围**
- 完整的用户操作流程
- 关键业务场景
- 跨浏览器兼容性

**示例：E2E测试**
```typescript
// e2e/prompt-management.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Prompt Management', () => {
  test.beforeEach(async ({ page }) => {
    // 登录
    await page.goto('/auth/login');
    await page.fill('input[name="email"]', 'test@example.com');
    await page.fill('input[name="password"]', 'password');
    await page.click('button[type="submit"]');
    await page.waitForURL('/dashboard');
  });

  test('creates and edits prompt', async ({ page }) => {
    // 创建提示词
    await page.click('button:has-text("New Prompt")');
    await page.fill('input[name="title"]', 'E2E Test Prompt');
    await page.fill('textarea[name="content"]', 'This is a test prompt');
    await page.fill('input[name="tags"]', 'test, e2e');
    await page.click('button:has-text("Save")');

    // 验证创建成功
    await expect(page.locator('text=E2E Test Prompt')).toBeVisible();

    // 编辑提示词
    await page.click('text=E2E Test Prompt');
    await page.click('button:has-text("Edit")');
    await page.fill('textarea[name="content"]', 'Updated content');
    await page.click('button:has-text("Save")');

    // 验证版本更新
    await page.click('tab:has-text("Versions")');
    await expect(page.locator('text=Version 2')).toBeVisible();
  });

  test('searches and filters prompts', async ({ page }) => {
    await page.goto('/prompts');
    
    // 搜索
    await page.fill('input[placeholder="Search prompts..."]', 'test');
    await page.press('input[placeholder="Search prompts..."]', 'Enter');
    
    // 验证搜索结果
    const results = page.locator('.prompt-card');
    await expect(results).toHaveCount(3);

    // 标签过滤
    await page.click('button:has-text("Filters")');
    await page.click('label:has-text("javascript")');
    await page.click('button:has-text("Apply")');
    
    await expect(results).toHaveCount(1);
  });

  test('version comparison', async ({ page }) => {
    await page.goto('/prompts/prompt-1');
    await page.click('tab:has-text("Versions")');
    
    // 选择两个版本进行比较
    await page.click('input[value="v1"]');
    await page.click('input[value="v2"]');
    await page.click('button:has-text("Compare")');
    
    // 验证差异显示
    await expect(page.locator('.diff-viewer')).toBeVisible();
    await expect(page.locator('.added-line')).toHaveCount(2);
    await expect(page.locator('.removed-line')).toHaveCount(1);
  });
});
```

### 3.4 测试数据管理

**测试数据策略**
```typescript
// test/fixtures/test-data.ts
export const testData = {
  users: [
    {
      id: 'user-1',
      email: 'test@example.com',
      name: 'Test User',
      role: 'admin'
    }
  ],
  projects: [
    {
      id: 'project-1',
      name: 'Test Project',
      ownerId: 'user-1'
    }
  ],
  prompts: [
    {
      id: 'prompt-1',
      title: 'Test Prompt 1',
      content: 'Content 1',
      projectId: 'project-1',
      version: 1
    }
  ]
};

// 数据库种子
export async function seedTestData(prisma: PrismaClient) {
  await prisma.user.createMany({ data: testData.users });
  await prisma.project.createMany({ data: testData.projects });
  await prisma.prompt.createMany({ data: testData.prompts });
}
```

## 4. 持续集成配置

### 4.1 GitHub Actions CI/CD

```yaml
# .github/workflows/test.yml
name: Test Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run unit tests
        run: |
          cd frontend
          npm run test:unit -- --coverage
      
      - name: Run component tests
        run: |
          cd frontend
          npm run test:components
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend

  test-backend:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          cd backend
          npm ci
      
      - name: Setup database
        run: |
          cd backend
          npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test
      
      - name: Run unit tests
        run: |
          cd backend
          npm run test:unit -- --coverage
      
      - name: Run integration tests
        run: |
          cd backend
          npm run test:integration
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage/lcov.info
          flags: backend

  test-e2e:
    runs-on: ubuntu-latest
    needs: [test-frontend, test-backend]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install Playwright
        run: npx playwright install --with-deps
      
      - name: Start application
        run: |
          docker-compose up -d
          sleep 10  # 等待服务启动
      
      - name: Run E2E tests
        run: |
          npm run test:e2e
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
```

## 5. 测试脚本配置

### 5.1 前端测试脚本

```json
// frontend/package.json
{
  "scripts": {
    "test": "jest",
    "test:unit": "jest --testPathPattern=unit",
    "test:components": "jest --testPathPattern=components",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui"
  },
  "jest": {
    "preset": "ts-jest",
    "testEnvironment": "jsdom",
    "setupFilesAfterEnv": ["<rootDir>/src/test/setup.ts"],
    "moduleNameMapper": {
      "^@/(.*)$": "<rootDir>/src/$1"
    },
    "coverageThreshold": {
      "global": {
        "branches": 60,
        "functions": 60,
        "lines": 60,
        "statements": 60
      }
    }
  }
}
```

### 5.2 后端测试脚本

```json
// backend/package.json
{
  "scripts": {
    "test": "jest",
    "test:unit": "jest --testPathPattern=unit",
    "test:integration": "jest --testPathPattern=integration --runInBand",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:ci": "jest --ci --coverage --maxWorkers=2"
  },
  "jest": {
    "preset": "ts-jest",
    "testEnvironment": "node",
    "setupFilesAfterEnv": ["<rootDir>/src/test/setup.ts"],
    "moduleNameMapper": {
      "^@/(.*)$": "<rootDir>/src/$1"
    },
    "coveragePathIgnorePatterns": [
      "/node_modules/",
      "/dist/",
      "/prisma/"
    ],
    "coverageThreshold": {
      "global": {
        "branches": 60,
        "functions": 60,
        "lines": 60,
        "statements": 60
      }
    }
  }
}
```

## 6. 测试执行计划

### 6.1 开发阶段
- 开发者本地运行单元测试
- 提交前运行相关测试
- PR必须通过所有测试

### 6.2 集成阶段
- 自动运行所有测试
- 生成测试报告
- 代码覆盖率检查

### 6.3 发布前
- 完整E2E测试
- 手动验收测试
- 回归测试

## 7. 测试报告和监控

### 7.1 测试报告
- 使用Jest HTML Reporter生成可视化报告
- 集成Codecov进行覆盖率追踪
- Playwright生成E2E测试报告

### 7.2 质量指标
- 单元测试覆盖率 >= 60%
- 核心功能覆盖率 >= 80%
- 0个高优先级bug
- API响应时间 < 200ms (平均)

## 8. 测试工具清单

```javascript
// 依赖安装命令
// 前端测试依赖
npm install --save-dev jest @testing-library/react @testing-library/jest-dom
npm install --save-dev @testing-library/user-event @types/jest ts-jest
npm install --save-dev @playwright/test

// 后端测试依赖
npm install --save-dev jest supertest @types/jest @types/supertest
npm install --save-dev ts-jest @faker-js/faker
npm install --save-dev @prisma/client prisma
```

## 9. 总结

本测试策略为提示词管理平台提供了完整的测试方案，包括：
- 三层测试架构（单元、集成、E2E）
- 自动化测试流程
- 持续集成配置
- 合理的覆盖率目标

通过实施此测试策略，可以确保产品质量，减少bug，提升开发效率。